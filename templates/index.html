{% extends 'base.html' %}
{% from 'bootstrap5/form.html' import render_form %}

{% block content %}
<div class="container-md" style="width: 640px;">

  <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
    <ol class="breadcrumb">
      {% if tab == 'Generate' %}
      <li class="breadcrumb-item active">Generate</a></li>
      <!-- <li class="breadcrumb-item active"></a>Simulate</li> -->
      {% else %}
      <li class="breadcrumb-item"><a href="/">Generate</a></li>
      <li class="breadcrumb-item active"></a>Simulate</li>
      {% endif %}
    </ol>
  </nav>
  
  {% if message %}
  <div class="alert alert-warning" role="alert"> {{ message }} </div>
  {% endif %}

  {% if img_file %}
    <h2>Terrain</h2>
    <img src="{{ img_file }}" alt="Terrain image" class="img mb-3">
  {% endif %}
  
  {{ render_form(form) }}
  </br>
    {% if result %}
    <h2>Simulation Statistics</h2>
    <div class="accordion mb-3" id="accordionExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            General
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne">
          <div class="accordion-body">
            <div class="stat"><span>Simulation time</span><span>{{ result["Simulation time"] }}</span></div>
            <div class="stat"><span>Total downlink time</span><span>{{ result["Total downlink time"] }}</span></div>
            <div class="stat"><span>Script execution time</span><span>{{ result["Script execution time"] }}</span></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingFive">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
            Node energy consumption
          </button>
        </h2>
        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive">
          <div class="accordion-body">
            <div class="stat"><span>Average </span><span>{{ result["Avg node consumption"] }}</span></div>
            <div class="stat"><span>Minimum </span><span>{{ result["Min node consumption"] }}</span></div>
            <div class="stat"><span>Maximum </span><span>{{ result["Max node consumption"] }}</span></div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Transmission
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo">
          <div class="accordion-body">
            <div class="stat"><span>Total number of transmissions</span><span>{{ result["Total number of transmissions"] }}</span></div>
            <div class="stat"><span>Total number of re-transmissions</span><span>{{ result["Total number of re-transmissions"] }}</span></div>
            <div class="stat"><span>Total number of unique transmissions</span><span>{{ result["Total number of unique transmissions"] }}</span></div>
            <div class="stat"><span>Standard deviation of unique transmissions</span><span>{{ result["Stdv of unique transmissions"] }}</span></div>
            <div class="stat"><span>Total packets delivered</span><span>{{ result["Total packets delivered"] }}</span></div>
            <div class="stat"><span>Total packets acknowledged</span><span>{{ result["Total packets acknowledged"] }}</span></div>
            <div class="stat"><span>Total confirmed packets dropped</span><span>{{ result["Total confirmed packets dropped"] }}</span></div>
            <div class="stat"><span>Total unconfirmed packets dropped</span><span>{{ result["Total unconfirmed packets dropped"] }}</span></div>
            <div class="stat"><span>Packet Delivery Ratio</span><span>{{ result["Packet Delivery Ratio"] }}</span></div>
            <div class="stat"><span>Packet Reception Ratio</span><span>{{ result["Packet Reception Ratio"] }}</span></div>
            <div class="stat"><span>No GW available in RX1</span><span>{{ result["No GW available in RX1"] }}</span></div>
            <div class="stat"><span>No GW available in RX1 or RX2</span><span>{{ result["No GW available in RX1 or RX2"] }}</span></div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingThree">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
            Gateways
          </button>
        </h2>
        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
          <div class="accordion-body">
            <h5>Number of sent ACKs and commands</h5>
            {% for gw, i in result["GW"] %}
            <div class="stat"><span>{{ gw }}</span><span>{{ i }}</span></div>
            {% endfor %}
            <div class="stat"><span>Downlink fairness</span><span>{{ result["Downlink fairness"] }}</span></div>
            <div class="stat"><span>Average number of retransmissions</span><span>{{ result["Avg number of retransmissions"] }}</span></div>
            <div class="stat"><span>Standard deviation of retransmissions</span><span>{{ result["Stdev of retransmissions"] }}</span></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingFour">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
            Node
          </button>
        </h2>
        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour">
          <div class="accordion-body">
            <table class="table table-striped table-hover table-borderless">
              <thead>
                <tr>
                  <th scope="col">SF</th>
                  <th scope="col">Number of nodes</th>
                  <th scope="col">Average retransmissions</th>
                </tr>
              </thead>
              <tbody>
                {% for sf, n, i in result["SF"] %}
                <tr>
                  <td>{{ sf }}</td>
                  <td>{{ n }}</td>
                  <td>{{ i }}</td>
                </tr>
                 {% endfor %}
              </tbody>
            </table>
            <div class="stat"><span>Average SF</span><span>{{ result["Avg SF"] }}</span></div>
            <div class="stat"><span>Average packet size</span><span>{{ result["Avg packet size"] }}</span></div>          </div>
        </div>
      </div>
    </div>
</div>
    {% endif %}


<script>
  document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('fixed');
      const distr = document.getElementById('distr');
      const size = document.getElementById('size').parentElement.querySelector("label");
      const auto_sim = document.getElementById('auto_sim');
      const sim = document.getElementById('sim');

      ["change", "load"].forEach(function(e){
        checkbox.addEventListener(e,function() {
          if (checkbox.checked) {
            // distr.classList.add("visually-hidden");
            distr.disabled = true;
            size.innerText = "Packet Size";
          } else {
            // distr.classList.remove("visually-hidden");
            distr.disabled = false;
            size.innerText = "Average Packet Size";
          }
        });
      });

      auto_sim.addEventListener('change', function() {
          if (auto_sim.checked) {
            sim.disabled = true;
          } else {
            sim.disabled = false;
          }
      });
  });
</script>

<style>
  .bar-chart {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      height: 60px;
      width: 480px;
      padding: 10px;
      border: 1px solid #ddd;
      background: #f9f9f9;
      position: relative;
  }
  .min{
    float:left;
    width:70%;
    overflow-x:auto;
    white-space: nowrap; 
    border: 1px solid #ddd;
    background-color: #3498db
  }
  .max{
    float:left;
    width:30%;
    overflow-x:auto;
    white-space: nowrap; 
    border: 1px solid #ddd;
    background-color: #3498db;
  }
  .bar span {
      position: absolute;
      bottom: -20px;
      width: 100%;
  }
  .legend {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
  }
  .legend div {
      display: flex;
      align-items: center;
  }
  .legend span {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 10px;
  }
  .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 8px;
        }
  .stat:nth-child(even) {
      background-color: #f9f9f9;
  }
  .img {
    max-width: 100%;
    max-height: 100%;
} 

</style>

{% endblock %}